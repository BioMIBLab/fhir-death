<!--
  -- Timeline-App/index.html
  --   Ryan Hoffman, 2016
  -- 
  -- Landing page for death app.
  -- 
  -->
<html>
  <head>
    
    <title>GT / CDC Death Reporting FHIR Application</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    
  </head>
  <body>
    
    <div class="landing-form">
      
      <h2>Death Certificate App</h2>
      <p class="small">Georgia Tech / CDC Death Reporting FHIR Prototype</p>
      <p>Connected to FHIR server: <span id="fhir-server">connecting....</span></p>
      <p>Patient ID: <input id="fhir-id"></input></p>
      <button class="nav" id="pt-select" onclick="window.alert('unimplemented!')">Patient Search</button>
      <button class="nav" id="load" onclick="app_launch()">Launch</button>
      
    </div>
    
    <!--  LOAD IN EXTERNAL JS RESOURCES  -->
    
    <script type="text/javascript" charset="utf-8" 
            src="./lib/d3.min.js"></script> <!-- should really just use jquery -->
    <script type="text/javascript" charset="utf-8" 
            src="./lib/fhir-client.min.js"></script> <!-- should really just use jquery -->
    

    <script type="text/javascript">
      
      // portions taken from smart-on-fhir demo app
      
      var connected = false;
      // var clientId = "gt-cdc-fhir-death"
      var clientId = "e850b7a4-0be6-406b-91d9-d15a81bd911b"
      // reg token: "eyJhbGciOiJSUzI1NiJ9.eyJhdWQiOlsiZTg1MGI3YTQtMGJlNi00MDZiLTkxZDktZDE1YTgxYmQ5MTFiIl0sImlzcyI6Imh0dHBzOlwvXC9hdXRob3JpemUtZHN0dTIuc21hcnRoZWFsdGhpdC5vcmdcLyIsImp0aSI6ImQ2N2FmYmM5LTM3ZTktNDAzYy1iMWMxLTNiNWM0ZDc0OGQ2OSIsImlhdCI6MTQ1NjU2MjU4MH0.AwoNdjpGnnsme-06xF8Rw__SGbr0nHNIVMKK6R8utSNb9Q8gnziGPRoZijvUL1zUFpcR2g0NnnvTuSyeRA9fibrhyQAy1V6vArRs6KgEl_i6TQuixFc1d_QC2WAD9jWaIkVGm_hCOBDKO6WNs5YYiI0TXiBtBOfQLDkMtLsIMWM"
      var secret = null;
      
      var urlparams = {}
      location.search.substr(1).split("&").forEach(function(element) {
        urlparams[element.split("=")[0]] = decodeURIComponent(element.split("=")[1]);
      }); // stackoverflow 5448545
      
      var serviceUrl = urlparams.iss;
      var launchUrl = window.location.href;
      var redirectUrl = launchUrl.replace("launch.html","");
      
      var launchContextId = urlparams.launch;
      
      var scope = [
        "patient/*.read",
        "launch"
      ].join(" ");
      
      var state = Math.round(Math.random()*100000000).toString();
      
      var conformanceUrl = serviceUrl + "/metadata"
      
      d3.json(conformanceUrl, function(d) {
        
        var authUrl, tokenUrl;
        
        var smart = d.rest[0].security.extension.filter(function (e) {
           return (e.url === "http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris");
        });
        smart[0].extension.forEach(function(arg, index, array){
          if (arg.url === "authorize") {
            authUrl = arg.valueUri;
          } else if (arg.url === "token") {
            tokenUrl = arg.valueUri;
          }
        });
        
        sessionStorage[state] = JSON.stringify({
            clientId: clientId,
            secret: secret,
            serviceUrl: serviceUrl,
            redirectUrl: redirectUrl,
            tokenUrl: tokenUrl
        });
        
//        FHIR.oauth2.authorize({
//          client_id: clientId,
//          scope: scope,
//          state: state
//        })
        
        window.location.href = authUrl + "?" +
            "response_type=code&" +
            "client_id=" + encodeURIComponent(clientId) + "&" +
            "scope=" + encodeURIComponent(scope) + "&" +
            "redirect_uri=" + encodeURIComponent(redirectUrl) + "&" +
            "aud=" + encodeURIComponent(serviceUrl) + "&" +
            "launch=" + launchContextId + "&" +
            "state=" + state;
        
      })
      
    </script>
    
  </body>
</html>